name: Update CNVpytor track demo
on:
  push:
    branches:
      - master
      - sync_web
      
  pull_request:
    branches:
      - master

env:
  BRANCH_NAME: web_page

jobs:
  check-branch:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check if Branch Exists
      id: check_branch
      run: |
        if git ls-remote --heads origin "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; then
          echo "::set-output name=branch_exists::true"
        else
          echo "::set-output name=branch_exists::false"
        fi
        
    - name: Pull Changes if Branch Exists
      if: steps.check_branch.outputs.branch_exists == 'true'
      run: |
        git config --global user.email 'rjit17@gmail.com'
        git config --global user.name "arpanda"
        git fetch origin
        git checkout web_page
        git pull origin web_page
        git rebase origin/master || (git rebase --abort && exit 1)
        git push origin web_page

    - name: Create Branch if not Exists
      if: steps.check_branch.outputs.branch_exists == 'false'
      run: |
        git config --global user.email 'rjit17@gmail.com'
        git config --global user.name "arpanda"
        git fetch origin master
        git switch master
        git checkout -b "$BRANCH_NAME"

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        
    - name: Install Dependencies
      run: npm install
    
    - name: Build
      run: npm run build

    - name: Remove node_modules
      run: rm -rf node_modules

    - name: Copy files
      run: |
        echo "Copying index.html"
        cp examples/cnvpytor/index.html cnvpytor.html

        echo "Copying cnvpytorTrackVCF.html"
        cp examples/cnvpytor/cnvpytorTrackVCF.html cnvpytorTrackVCF.html

        echo "Copying cnvpytorTrack.html"
        cp examples/cnvpytor/cnvpytorTrack.html cnvpytorTrack.html

    - name: Commit and Push Changes
      run: |
        git config --global user.email 'rjit17@gmail.com'
        git config --global user.name "arpanda"
        git add .
        git add -f dist/
        git commit -m "build web page"
        if [[ "${{ steps.check_branch.outputs.branch_exists }}" == 'true' ]]; then
          git push origin "$BRANCH_NAME"
        else
          git push --set-upstream origin "$BRANCH_NAME"
        fi
