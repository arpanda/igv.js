name: Build and Push to Existing or New Branch
on:
  push:
    branches:
      - master
      - sync_web
      
  pull_request:
    branches:
      - master

env:
  BRANCH_NAME: web_page

jobs:
  check-branch:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Check if Branch Exists
      id: check_branch
      run: |
        if git ls-remote --heads origin "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; then
          BRANCH_EXISTS=true
        else
          BRANCH_EXISTS=false
        fi
        echo "Branch exists: $BRANCH_EXISTS"
        echo "branch_exists=true" >> $GITHUB_ENV
        echo "branch_exists=$BRANCH_EXISTS" >> $GITHUB_ENV
        
    - name: Pull Changes if Branch Exists
      if: steps.check_branch.outputs.branch_exists == 'true'
      run: |
        git config --global user.email 'rjit17@gmail.com'
        git config --global user.name "arpanda"
        git config pull.rebase true
        git fetch origin
        git switch "$BRANCH_NAME"
        git rebase origin/master
        git pull origin "$BRANCH_NAME"
        git push origin "$BRANCH_NAME"
      

    - name: Create Branch if not Exists
      if: steps.check_branch.outputs.branch_exists == 'false'
      run: |
        git config --global user.email 'rjit17@gmail.com'
        git config --global user.name "arpanda"
        git fetch origin master
        git switch master
        git checkout -b "$BRANCH_NAME"

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'
        
    - name: Install Dependencies
      run: npm install
    
    - name: Build
      run: npm run build

    - name: Remove node_modules
      run: rm -rf node_modules

    - name: Copy files
      run: |
        echo "Copying index.html"
        cp examples/cnvpytor/index.html cnvpytor.html

        echo "Copying cnvpytorTrackVCF.html"
        cp examples/cnvpytor/cnvpytorTrackVCF.html cnvpytorTrackVCF.html

        echo "Copying cnvpytorTrack.html"
        cp examples/cnvpytor/cnvpytorTrack.html cnvpytorTrack.html

    - name: Commit and Push Changes
      run: |
        git config --global user.email 'rjit17@gmail.com'
        git config --global user.name "arpanda"
        git add .
        git add -f dist/
        git commit -m "build web page"
        if [[ ${{ steps.check_branch.outputs.branch_exists }} == 'true' ]]; then
          git push origin "$BRANCH_NAME"
        else
          git push --set-upstream origin "$BRANCH_NAME"
        fi
